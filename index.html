<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Furniture ERP â€” PWA v1.3</title>
  <meta name="theme-color" content="#111111">
  <link rel="manifest" href="manifest.json">
  <style>
    :root { --bg:#0f0f10; --fg:#f2f2f3; --muted:#b9bcc2; --card:#1a1b1e; --acc:#4da3ff; --good:#16a34a; --bad:#ef4444; --warn:#f59e0b; }
    @media (prefers-color-scheme: light) { :root { --bg:#f7f7f8; --fg:#0f1115; --muted:#475569; --card:#ffffff; --acc:#2563eb; } }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial; }
    header { position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(8px); background:#111a; border-bottom:1px solid #0004; }
    .bar { display:flex; gap:.6rem; align-items:center; padding:.7rem .9rem; }
    .title { font-weight:800; letter-spacing:.2px; }
    .tabs { display:flex; gap:.4rem; flex-wrap:wrap; margin-left:auto; }
    .tab { border:1px solid #0004; padding:.45rem .7rem; border-radius:9px; cursor:pointer; background:var(--card); color:var(--fg); user-select:none; }
    .tab.active { outline:2px solid var(--acc); }
    main { max-width:1200px; margin: 1rem auto; padding: 0 .9rem 4rem; }
    .kpis { display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr)); gap:.9rem; margin:1rem 0; }
    .kpi { background:var(--card); border:1px solid #0004; border-radius:12px; padding:1rem; }
    .muted { color:var(--muted); }
    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin:.7rem 0 1rem; }
    input, select, button { padding:.5rem .6rem; border-radius:8px; border:1px solid #0004; background:var(--card); color:var(--fg); }
    button.primary { background: var(--acc); color: white; border: none; }
    button.danger { background: var(--bad); color: white; border: none; }
    .grid { overflow:auto; border:1px solid #0004; border-radius:10px; background:var(--card); }
    table { width:100%; border-collapse:collapse; min-width:820px; }
    th, td { padding:.6rem .7rem; border-bottom:1px solid #0002; text-align:left; white-space:nowrap; }
    th { position:sticky; top:0; background:#1f2226; }
    tr.selected { outline: 2px solid var(--acc); }
    .fab { position:fixed; right:18px; bottom:18px; background:var(--acc); color:#fff; border:none; border-radius:999px; padding:14px 18px; font-weight:700; cursor:pointer; box-shadow:0 10px 30px #0006; }
    .fab small { display:block; font-weight:400; opacity:.8; }
    /* Modal */
    .modal-back { position:fixed; inset:0; background:#0008; display:none; align-items:center; justify-content:center; padding:1rem; z-index:50; }
    .modal { width:min(680px, 100%); background:var(--card); border:1px solid #0005; border-radius:14px; padding:1rem; }
    .modal h3 { margin:.2rem 0 1rem; }
    .modal .row { display:grid; grid-template-columns:150px 1fr; align-items:center; gap:.6rem; margin:.5rem 0; }
    .modal .actions { display:flex; gap:.6rem; justify-content:flex-end; margin-top:1rem; }
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">ðŸªµ Furniture ERP</div>
    <div class="tabs">
      <div class="tab active" data-view="dashboard">Dashboard</div>
      <div class="tab" data-view="orders">Orders</div>
      <div class="tab" data-view="invoices">Invoices</div>
      <div class="tab" data-view="pos">Purchases (PO)</div>
      <div class="tab" data-view="tools">Tools</div>
      <div class="tab" data-view="import">Import/Export</div>
      <div class="tab" data-view="about">About</div>
    </div>
  </div>
</header>

<main>
  <section id="dashboard" class="view">
    <h2>Dashboard</h2>
    <div class="kpis" id="kpiBox"></div>
    <div class="muted">Data loaded from <code>initial_data.json</code> and saved to LocalStorage.</div>
  </section>

  <section id="orders" class="view" hidden>
    <h2>Orders</h2>
    <div class="toolbar">
      <input id="ordersSearch" placeholder="Search">
      <select id="ordersStatus"></select>
      <button id="btnNewClient" class="primary">+ New client</button>
      <button id="btnNewOrder" class="primary">+ New order (guided)</button>
      <button id="saveOrders">Save</button>
    </div>
    <div class="grid"><table id="ordersTable"></table></div>
  </section>

  <section id="invoices" class="view" hidden>
    <h2>Invoices</h2>
    <div class="toolbar">
      <input id="invoicesSearch" placeholder="Search">
      <button id="saveInvoices">Save</button>
    </div>
    <div class="grid"><table id="invoicesTable"></table></div>
  </section>

  <section id="pos" class="view" hidden>
    <h2>Purchases (PO)</h2>
    <div class="toolbar">
      <input id="posSearch" placeholder="Search">
      <button id="savePOs">Save</button>
    </div>
    <div class="grid"><table id="posTable"></table></div>
  </section>

  <section id="tools" class="view" hidden>
    <h2>Tools</h2>
    <div class="toolbar">
      <input id="ciOrderId" placeholder="Order ID">
      <button id="ciCreate" class="primary">Create invoice</button>
      <span class="muted">IssueDate=today, DueDate=+21d, Amount from order Total/Amount.</span>
    </div>
  </section>

  <section id="import" class="view" hidden>
    <h2>Import / Export</h2>
    <div style="display:grid; gap:.8rem; max-width:700px;">
      <button id="exportBtn">â¬‡ Export JSON</button>
      <input type="file" id="importFile" accept="application/json">
      <button id="resetBtn">â†º Reset to initial</button>
    </div>
  </section>

  <section id="about" class="view" hidden>
    <h2>About</h2>
    <p>Version v1.3 â€” guided workflow: Client â†’ Order â†’ (optional) Invoice/PO. Modals added.</p>
  </section>
</main>

<button class="fab" id="fabStart">+ Start<br><small>Client â†’ Order</small></button>

<!-- Client modal -->
<div class="modal-back" id="modalClientBack">
  <div class="modal">
    <h3>New client</h3>
    <div class="row"><label>Client ID</label><input id="clId" placeholder="auto"></div>
    <div class="row"><label>Name</label><input id="clName" placeholder="Full name"></div>
    <div class="row"><label>Phone</label><input id="clPhone" placeholder="+1 ..."></div>
    <div class="row"><label>Email</label><input id="clEmail" placeholder="name@mail.com"></div>
    <div class="row"><label>Address</label><input id="clAddr" placeholder=""></div>
    <div class="actions">
      <button id="clCancel">Cancel</button>
      <button id="clSave" class="primary">Save client</button>
    </div>
  </div>
</div>

<!-- Order modal -->
<div class="modal-back" id="modalOrderBack">
  <div class="modal">
    <h3>New order</h3>
    <div class="row"><label>Order ID</label><input id="orId" placeholder="auto"></div>
    <div class="row"><label>Client ID</label><input id="orClientId" placeholder="auto from client" disabled></div>
    <div class="row"><label>Status</label>
      <select id="orStatus">
        <option>New</option>
        <option>In Production</option>
        <option>On Hold</option>
        <option>Installed</option>
        <option>Closed</option>
        <option>Cancelled</option>
      </select>
    </div>
    <div class="row"><label>Total</label><input id="orTotal" placeholder="0.00"></div>
    <div class="actions">
      <button id="orCancel">Cancel</button>
      <button id="orSave" class="primary">Save order</button>
    </div>
  </div>
</div>

<script>
// ---- Storage / data ----
const KEY = "furniture_erp_data_v13";
let db = null;
const tables = {};

function $(sel){ return document.querySelector(sel); }
function el(tag, attrs={}, children=[]){ const n=document.createElement(tag); for(const[k,v]of Object.entries(attrs)){ if(k==="text")n.textContent=v; else if(k==="html")n.innerHTML=v; else n.setAttribute(k,v);} for(const c of children) n.appendChild(c); return n; }
function unique(a){ return [...new Set(a)]; }
function toNumber(x){ const n=parseFloat(String(x||"").replace(/[^0-9.\-]/g,"")); return isNaN(n)?0:n; }
function fmtDate(d){ const z=n=>String(n).padStart(2,"0"); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }

function setData(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }
function getData(){ const raw=localStorage.getItem(KEY); return raw?JSON.parse(raw):null; }

function detectTables(){
  const names = Object.keys(db).map(n=>n.toLowerCase());
  const find = (cands, fb="") => { for(const c of cands){ const i=names.indexOf(c); if(i>=0) return Object.keys(db)[i]; } return Object.keys(db)[0]||fb; };
  tables.orders = find(["orders","order","Ð·Ð°ÐºÐ°Ð·Ñ‹","active orders"]);
  tables.invoices = find(["invoices","invoice","Ð¸Ð½Ð²Ð¾Ð¹ÑÑ‹","Ð¸Ð½Ð²Ð¾Ð¹Ñ"]);
  tables.pos = find(["hardwarepo","hardware po","po","purchase orders","Ð·Ð°ÐºÑƒÐ¿ÐºÐ¸"]);
  tables.clients = find(["clients","client","customers","ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹","ÐºÐ»Ð¸ÐµÐ½Ñ‚"]);
}

function detectField(obj, patterns){ const keys=Object.keys(obj||{}); for(const p of patterns){ const re=new RegExp(p,"i"); const k=keys.find(k=>re.test(k)); if(k) return k; } return null; }

// ---- Rendering ----
function renderTable(sel, rows){
  const table = $(sel); table.innerHTML="";
  if(!rows||!rows.length){ table.innerHTML="<tr><td class='muted'>No data</td></tr>"; return; }
  const cols = Object.keys(rows[0]);
  const thead=el("thead"); const trh=el("tr"); cols.forEach(c=>trh.appendChild(el("th",{text:c}))); thead.appendChild(trh);
  const tbody=el("tbody");
  rows.forEach((r,idx)=>{ const tr=el("tr"); cols.forEach(c=>{ const td=el("td",{text:r[c]===undefined?"":String(r[c])}); td.contentEditable=true; td.addEventListener("input",()=>{ r[c]=td.innerText;}); tr.appendChild(td);}); tbody.appendChild(tr); });
  table.appendChild(thead); table.appendChild(tbody);
}

function computeKPIs(){
  const orders = db[tables.orders]||[];
  const statusField = orders.length ? (Object.keys(orders[0]).find(k=>/status|ÑÑ‚Ð°Ñ‚ÑƒÑ/i.test(k))||null) : null;
  const total=orders.length;
  const active=statusField?orders.filter(r=>String(r[statusField]||"").match(/^(new|in.?prod|on.?hold)/i)).length:total;
  const closed=statusField?orders.filter(r=>String(r[statusField]||"").match(/(installed|closed?|cancel(l)?ed)/i)).length:0;
  const priceField = orders.length ? (Object.keys(orders[0]).find(k=>/(total|amount|price)/i.test(k))||null) : null;
  const totalSum = priceField ? orders.reduce((s,r)=>s+toNumber(r[priceField]),0) : 0;
  return [
    {label:"Total orders", value: total},
    {label:"Active", value: active},
    {label:"Closed/Installed", value: closed},
    {label: priceField?`Sum by Â«${priceField}Â»`:"Sum", value: priceField? totalSum.toLocaleString('en-US',{style:'currency',currency:'USD'}) : "â€”"}
  ];
}
function renderKPIs(){ const box=$("#kpiBox"); box.innerHTML=""; computeKPIs().forEach(k=>{ box.appendChild(el("div",{class:"kpi"},[ el("div",{class:"muted",text:k.label}), el("div",{style:"font-size:26px;font-weight:800;margin-top:.2rem;",text:String(k.value)}) ])); }); }

function populateStatusFilter(){
  const orders=db[tables.orders]||[]; const sel=$("#ordersStatus"); sel.innerHTML=""; sel.appendChild(el("option",{value:"",text:"Status: any"}));
  if(!orders.length) return; const statusField=Object.keys(orders[0]).find(k=>/status|ÑÑ‚Ð°Ñ‚ÑƒÑ/i.test(k)); if(!statusField) return; sel.dataset.field=statusField;
  unique(orders.map(r=>r[statusField]).filter(Boolean)).sort((a,b)=>String(a).localeCompare(String(b))).forEach(v=> sel.appendChild(el("option",{value:String(v),text:String(v)})) );
}

function refreshOrders(){ const q=$("#ordersSearch").value.toLowerCase().trim(); const statusSel=$("#ordersStatus"); const statusField=statusSel.dataset.field||""; const only=statusSel.value;
  let rows=(db[tables.orders]||[]).slice(); if(q) rows=rows.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(q))); if(only&&statusField) rows=rows.filter(r=>String(r[statusField])===only);
  renderTable("#ordersTable", rows);
}
function refreshInvoices(){ const q=$("#invoicesSearch").value.toLowerCase().trim(); let rows=(db[tables.invoices]||[]).slice(); if(q) rows=rows.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(q))); renderTable("#invoicesTable", rows); }
function refreshPOs(){ const q=$("#posSearch").value.toLowerCase().trim(); let rows=(db[tables.pos]||[]).slice(); if(q) rows=rows.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(q))); renderTable("#posTable", rows); }

// ---- Guided workflow ----
function openModal(id){ $(id).style.display="flex"; }
function closeModal(id){ $(id).style.display="none"; }

function genId(prefix){ const now=new Date(); const rnd=Math.floor(100+Math.random()*900); return `${prefix}-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}-${rnd}`; }

let lastClient = null;

function newClientFlow(){
  $("#clId").value = genId("C");
  $("#clName").value = ""; $("#clPhone").value=""; $("#clEmail").value=""; $("#clAddr").value="";
  openModal("#modalClientBack");
}

function saveClient(){
  const clientsName = tables.clients || "Clients";
  const clients = db[clientsName] = db[clientsName] || [];
  const sample = clients[0] || {};
  const idF = detectField(sample, ["^client.?id$","^id$"]) || "ClientID";
  const nameF = detectField(sample, ["name|full.?name|fio"]) || "Name";
  const phoneF = detectField(sample, ["phone|Ñ‚ÐµÐ»"]) || "Phone";
  const emailF = detectField(sample, ["email|Ð¿Ð¾Ñ‡Ñ‚Ð°"]) || "Email";
  const addrF = detectField(sample, ["address|addr|Ð°Ð´Ñ€ÐµÑ"]) || "Address";

  const row = sample && Object.keys(sample).length ? Object.fromEntries(Object.keys(sample).map(k=>[k,""])) :
    {[idF]:"",[nameF]:"",[phoneF]:"",[emailF]:"",[addrF]:""};

  row[idF] = $("#clId").value.trim() || genId("C");
  row[nameF] = $("#clName").value.trim();
  row[phoneF] = $("#clPhone").value.trim();
  row[emailF] = $("#clEmail").value.trim();
  row[addrF] = $("#clAddr").value.trim();

  clients.unshift(row);
  setData(db);
  lastClient = { idF, id: row[idF] };
  closeModal("#modalClientBack");
  // Go to order modal
  newOrderFlow();
}

function newOrderFlow(){
  const orders = db[tables.orders] = db[tables.orders] || [];
  const sample = orders[0] || {};
  const orderIdF = detectField(sample, ["^order.?id$","^id$"]) || "OrderID";
  const clientIdF = detectField(sample, ["client.?id","customer.?id","ÐºÐ»Ð¸ÐµÐ½Ñ‚.?id"]) || "ClientID";
  $("#orId").value = genId("O");
  $("#orClientId").value = lastClient ? lastClient.id : "";
  $("#orStatus").value = "New";
  $("#orTotal").value = "";
  openModal("#modalOrderBack");
  // Keep field names for save
  $("#orSave").dataset.orderField = orderIdF;
  $("#orSave").dataset.clientField = clientIdF;
}

function saveOrder(btn){
  const orders = db[tables.orders] = db[tables.orders] || [];
  const orderIdF = btn.dataset.orderField || "OrderID";
  const clientIdF = btn.dataset.clientField || "ClientID";
  const statusF = detectField(orders[0]||{}, ["status|ÑÑ‚Ð°Ñ‚ÑƒÑ"]) || "Status";
  const totalF = detectField(orders[0]||{}, ["total|amount|price|ÑÑƒÐ¼Ð¼Ð°|Ð¸Ñ‚Ð¾Ð³"]) || "Total";

  const row = orders[0] ? Object.fromEntries(Object.keys(orders[0]).map(k=>[k,""])) :
    {[orderIdF]:"",[clientIdF]:"",[statusF]:"",[totalF]:""};

  row[orderIdF] = $("#orId").value.trim() || genId("O");
  row[clientIdF] = $("#orClientId").value.trim();
  row[statusF] = $("#orStatus").value;
  row[totalF] = $("#orTotal").value;

  orders.unshift(row);
  setData(db);
  closeModal("#modalOrderBack");
  // Go to Orders tab and refresh
  show("orders"); renderKPIs(); populateStatusFilter(); refreshOrders();
  alert("Client and Order saved âœ…");
}

// ---- Navigation ----
function show(view){ document.querySelectorAll(".view").forEach(v=>v.hidden=true); document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")); document.getElementById(view).hidden=false; document.querySelector(`.tab[data-view="${view}"]`).classList.add("active"); }

function boot(){ renderKPIs(); populateStatusFilter(); refreshOrders(); refreshInvoices(); refreshPOs(); }

// ---- Events ----
document.addEventListener("click", (e)=>{ const t=e.target.closest(".tab"); if(t){ show(t.dataset.view); } });
addEventListener("load", async ()=>{
  try{
    db = getData();
    if(!db){
      const resp = await fetch("initial_data.json",{cache:"reload"});
      db = await resp.json();
      setData(db);
    }
    detectTables();
    boot();
  }catch(err){ alert("Data load error: "+err.message); console.error(err); }
});

document.addEventListener("DOMContentLoaded", ()=>{
  $("#ordersSearch").addEventListener("input", refreshOrders);
  $("#ordersStatus").addEventListener("change", refreshOrders);
  $("#saveOrders").addEventListener("click", ()=> { setData(db); alert("Saved âœ…"); });

  $("#invoicesSearch").addEventListener("input", refreshInvoices);
  $("#saveInvoices").addEventListener("click", ()=> { setData(db); alert("Saved âœ…"); });

  $("#posSearch").addEventListener("input", refreshPOs);
  $("#savePOs").addEventListener("click", ()=> { setData(db); alert("Saved âœ…"); });

  $("#exportBtn").addEventListener("click", ()=>{ const blob=new Blob([JSON.stringify(db,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="furniture_erp_data.json"; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); });
  $("#importFile").addEventListener("change", e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ db=JSON.parse(r.result); setData(db); boot(); alert("Imported âœ…"); }catch(err){ alert("Import error: "+err.message);} }; r.readAsText(f,"utf-8"); });
  $("#resetBtn").addEventListener("click", ()=>{ localStorage.removeItem(KEY); location.reload(); });

  // Guided
  $("#fabStart").addEventListener("click", newClientFlow);
  $("#btnNewClient").addEventListener("click", newClientFlow);
  $("#btnNewOrder").addEventListener("click", ()=> { if(!lastClient) newClientFlow(); else newOrderFlow(); });

  // Modal actions
  $("#clCancel").addEventListener("click", ()=> closeModal("#modalClientBack"));
  $("#clSave").addEventListener("click", saveClient);

  $("#orCancel").addEventListener("click", ()=> closeModal("#modalOrderBack"));
  $("#orSave").addEventListener("click", (e)=> saveOrder(e.target));

  // Tools
  $("#ciCreate").addEventListener("click", ()=>{
    const id = $("#ciOrderId").value.trim(); if(!id) return alert("Enter Order ID");
    // Create invoice like in v1.2
    const orders = db[tables.orders]||[]; if(!orders.length) return alert("No orders");
    const orderIdField = detectField(orders[0], ["^order.?id$","Ð·Ð°ÐºÐ°Ð·.?id","^id$"]); if(!orderIdField) return alert("Order ID field not found");
    const found=orders.find(r=>String(r[orderIdField]).trim()===String(id).trim()); if(!found) return alert("Order not found");
    const invoices=db[tables.invoices]=db[tables.invoices]||[];
    const amountFieldOrder=detectField(found,["total","amount","price","Ð¸Ñ‚Ð¾Ð³","ÑÑƒÐ¼Ð¼Ð°"]); const amount=amountFieldOrder?String(found[amountFieldOrder]):"";
    const today=new Date(); const rnd=Math.floor(1000+Math.random()*9000); const invId=`INV-${today.getFullYear()}${String(today.getMonth()+1).padStart(2,"0")}${String(today.getDate()).padStart(2,"0")}-${rnd}`;
    const issue=fmtDate(today); const due=fmtDate(new Date(today.getTime()+21*24*3600*1000));
    const invRow=invoices[0]?Object.fromEntries(Object.keys(invoices[0]).map(k=>[k,""])):{InvoiceID:"",OrderID:"",IssueDate:"",DueDate:"",Amount:""};
    const invIdField=detectField(invRow,["invoice.?id","^id$"])||"InvoiceID"; const orderIdFieldInv=detectField(invRow,["order.?id","Ð·Ð°ÐºÐ°Ð·.?id"])||"OrderID";
    const issueField=detectField(invRow,["issue.?date","date","invoice.?date","Ð´Ð°Ñ‚Ð°"])||"IssueDate"; const dueField=detectField(invRow,["due.?date","ÑÑ€Ð¾Ðº"])||"DueDate"; const amountFieldInv=detectField(invRow,["amount|total|price|ÑÑƒÐ¼Ð¼Ð°|Ð¸Ñ‚Ð¾Ð³"])||"Amount";
    invRow[invIdField]=invId; invRow[orderIdFieldInv]=found[orderIdField]; invRow[issueField]=issue; invRow[dueField]=due; invRow[amountFieldInv]=amount;
    invoices.unshift(invRow); setData(db); refreshInvoices(); alert(`Invoice created: ${invId}`);
  });
});

// SW
if("serviceWorker" in navigator){ addEventListener("load", ()=> navigator.serviceWorker.register("service-worker.js").catch(console.error)); }
</script>
</body>
</html>
